// Prisma schema for multi-instrument trading journal
// Config driven: instrument types can be extended via Instrument table

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // shadowDatabaseUrl can be defined in .env for safer migrate dev if needed
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  // For credentials auth (hashed with bcrypt). Null when user exclusively uses OAuth.
  passwordHash  String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  trades        Trade[]
  strategies    Strategy[]
  journalSettings JournalSettings?
  tradeTags     TradeTag[]
  goals         Goal[]
  riskBreachLogs RiskBreachLog[]
  // Persistent export jobs (enabled via ENABLE_EXPORTS=1)
  exportJobs    ExportJob[]
  // Pre-aggregated daily equity snapshots
  dailyEquity   DailyEquity[]
  // Prop firm evaluations
  propEvaluations PropEvaluation[]
}

model Instrument {
  id          String   @id @default(cuid())
  symbol      String   @unique
  name        String
  category    String   // e.g. Futures, Forex, Crypto, Stock
  currency    String
  tickSize    Float
  contractMultiplier Float? // for futures
  isActive    Boolean  @default(true)
  trades      Trade[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TradeTag {
  id        String   @id @default(cuid())
  label     String
  color     String   @default("#3b82f6")
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  trades    TradeTagOnTrade[]
  createdAt DateTime @default(now())
}

model TradeTagOnTrade {
  tradeId String
  tagId   String
  trade   Trade   @relation(fields: [tradeId], references: [id])
  tag     TradeTag @relation(fields: [tagId], references: [id])
  @@id([tradeId, tagId])
  @@index([tagId])
  @@index([tradeId])
}

model Strategy {
  id          String      @id @default(cuid())
  user        User        @relation(fields: [userId], references: [id])
  userId      String
  name        String
  description String?
  status      String      @default("OPEN") // OPEN, CLOSED
  trades      Trade[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?   // soft delete marker

  @@index([userId])
}

model Trade {
  id          String      @id @default(cuid())
  user        User        @relation(fields: [userId], references: [id])
  userId      String
  instrument  Instrument  @relation(fields: [instrumentId], references: [id])
  instrumentId String
  strategy    Strategy?   @relation(fields: [strategyId], references: [id])
  strategyId  String?
  direction   TradeDirection
  entryPrice  Float
  exitPrice   Float?
  quantity    Int         // lots / contracts / shares
  leverage    Float?      // optional
  entryAt     DateTime
  exitAt      DateTime?
  fees        Float       @default(0)
  notes       String?
  reason      String?     // reason for trade
  lesson      String?     // what was learned
  status      TradeStatus @default(OPEN)
  tags        TradeTagOnTrade[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?   // soft delete marker

  @@index([userId, instrumentId, entryAt])
  @@index([userId, deletedAt])
  @@index([userId, exitAt])
  @@index([userId, status, exitAt])
  @@index([strategyId])
}

enum TradeDirection {
  LONG
  SHORT
}

enum TradeStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum UserRole {
  USER
  ADMIN
}

model JournalSettings {
  id             String   @id @default(cuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String   @unique
  baseCurrency   String   @default("USD")
  riskPerTradePct Float   @default(1)
  maxDailyLossPct Float   @default(3)
  initialEquity   Float   @default(100000) // starting equity baseline for risk % calculations
  maxConsecutiveLossesThreshold Int @default(5)
  timezone       String   @default("UTC")
  theme          String   @default("dark") // ui theme preference (dark | light)
  highContrast   Boolean  @default(false)   // user enabled high contrast adjustments
  // Observability timestamps for equity pre-aggregation integrity
  lastEquityValidationAt DateTime?
  lastEquityRebuildAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Milestone 5: Goals (basic scaffold)
model Goal {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  type        GoalType
  period      GoalPeriod // e.g. MONTHLY
  targetValue Float
  currentValue Float      @default(0)
  startDate   DateTime
  endDate     DateTime
  achievedAt  DateTime?
  // For rolling window goals (e.g., 7/30/90 day PnL) we store window length in days.
  windowDays  Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  @@index([userId, period, endDate])
}

// Risk breach log (Milestone 5 expansion)
model RiskBreachLog {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String   // DAILY_LOSS, MAX_CONSECUTIVE_LOSSES, etc.
  message   String
  value     Float
  limit     Float
  createdAt DateTime @default(now())
  @@index([userId, createdAt])
}

// Persistent export job queue (replaces in-memory for production)
model ExportJob {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  type        String
  format      String
  paramsJson  Json
  status      String   @default("queued") // queued | running | completed | failed
  // Correlation id from originating HTTP request (added for tracing)
  requestId   String?  @map("request_id")
  error       String?
  filename    String?
  contentType String?
  payloadBase64 String?
  attemptCount Int      @default(0) // retry attempts performed
  nextAttemptAt DateTime? // scheduled time for next retry when transient failure occurs
  // Download token controls (expiry + one-time use)
  downloadTokenExpiresAt DateTime? // when the current download token expires (regenerated on list/create)
  downloadTokenConsumedAt DateTime? // set after successful download (one-time use enforcement)
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([nextAttemptAt])
  @@index([requestId])
}

// Pre-aggregated daily equity / PnL (performance optimization for large datasets)
model DailyEquity {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime // UTC date (normalized to start of day)
  realizedPnl Float  @default(0)
  cumulativeEquity Float
  tradeCount Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, date])
  @@index([userId, date])
}

// Prop firm evaluation tracking (Milestone 10)
model PropEvaluation {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  firmName        String
  phase           String   @default("PHASE1") // PHASE1 | PHASE2 | FUNDED | RESET
  accountSize     Float
  profitTarget    Float
  maxDailyLoss    Float
  maxOverallLoss  Float
  // Maximum allowed single-trade risk as a percent of account size (e.g., 1.0 = 1%)
  maxSingleTradeRisk Float?
  trailing        Boolean  @default(false)
  minTradingDays  Int      @default(0)
  consistencyBand Float?   @default(0.4)
  startDate       DateTime
  endDate         DateTime?
  status          String   @default("ACTIVE") // ACTIVE | PASSED | FAILED | ARCHIVED
  cumulativeProfit Float   @default(0)
  peakEquity      Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  @@index([userId, status])
}

// Cron job execution log

// Foreign exchange daily rate storage (for currency conversion)
model FxRate {
  id        String   @id @default(cuid())
  date      DateTime // UTC date (YYYY-MM-DD)
  base      String   // e.g., USD
  quote     String   // e.g., EUR
  rate      Float    // quote per 1 base
  source    String   @default("frankfurter")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, base, quote])
  @@index([base, quote, date])
}

enum GoalType {
  TOTAL_PNL
  TRADE_COUNT
  WIN_RATE
  PROFIT_FACTOR
  EXPECTANCY
  AVG_LOSS_CAP
  DAILY_GREEN_STREAK
  ROLLING_30D_PNL
  ROLLING_WINDOW_PNL
}

enum GoalPeriod {
  MONTH
  QUARTER
  YEAR
}
